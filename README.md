CDR Service
---

## Описание проекта

Этот проект представляет собой микросервис для генерации и обработки данных в формате CDR (Call Data Record), агрегации их в отчёты UDR (Usage Data Report) и предоставления REST API для взаимодействия с этими данными. Проект реализован на языке Java с использованием Spring Boot, H2 Database и Maven.

Проект выполнен в соответствии с требованиями технического задания (ТЗ). Ниже описаны ключевые функциональные возможности, используемые технологии, инструкции по запуску и тестированию приложения.

## Функциональность

### 1. Генерация CDR записей:
- Создаются записи о звонках абонентов за 1 год.
- Записи сохраняются в базу данных H2.
- Количество и длительность звонков определяются случайным образом, но с поддержкой правдоподобия (время звонка до 2 часов, обычно меньше; абонент не может говорить сам с собой; абонент не может одновременно говорить с разными людьми с одного номера).
- Данные генерируются в хронологическом порядке. И для дальнейшего масштабирования осуществляется пакетной вставкой данных.
### 2. REST API для работы с UDR:
- Получение UDR отчёта для конкретного абонента (за месяц или весь период).
- Получение UDR отчётов для всех абонентов за указанный месяц.
- Генерация CDR-отчёта:
- Создание CSV-файла с записями CDR для указанного абонента и периода времени.
- Файл сохраняется в директории `/reports` с уникальным именем, содержащим номер абонента и UUID запроса.
### 3. Тестирование:
- Код покрыт тестами с использованием JUnit и Mockito.
- Покрытие тестами превышает 75%.
### 4. Релиз:
- Приложение упаковано в исполняемый JAR-файл с зависимостями.
- JAR-файл доступен в разделе GitHub Releases.

## Используемые технологии

### 1. Язык программирования:
- Java 17 (OpenJDK).
### 2. Фреймворк:
- Spring Boot (для создания микросервиса).
- Spring Data JPA (для работы с базой данных).
- Spring Web (для реализации REST API).
### 3. База данных:
- H2 Database (встраиваемая база данных для локального использования).
### 4. Сборка проекта:
- Maven (для управления зависимостями и сборки).
### 5. Тестирование:
- JUnit 5 (для модульного тестирования).
- Mockito (для мокирования зависимостей).
- JaCoCo (для анализа покрытия тестами).

## Архитектура проекта

Проект организован в соответствии с принципами чистой архитектуры:

1. **Entity**: Сущности (`CdrRecord`, `Subscriber`) представляют данные, хранящиеся в базе данных.
2. **Repository**: Репозитории (`CdrRecordRepository`, `SubscriberRepository`) предоставляют доступ к данным через Spring Data JPA.
3. **Service**: Сервисы (`CdrGeneratorService`, `UdrService`) содержат бизнес-логику приложения.
4. **Controller**: Контроллер (`UdrController`) предоставляет REST API для взаимодействия с пользователем.
5. **Configuration**: Конфигурационные файлы (`application.properties`, `application-local.yml`) позволяют настраивать приложение.

## Инструкции по запуску

В корне директории запуска надо иметь папку `/reports`.

### 1. Через JAR-файл:
  1. Скачайте JAR-файл из раздела [Releases](https://github.com/ekaterinakrylovao/cdr-service/releases/tag/v1.0.0).
  2. Убедитесь, что у вас установлена Java 17 или выше. Проверить версию можно командой:
     ```bash
     java -version
     ```
  3. Запустите приложение:
     ```bash
     java -jar cdr-service-0.0.1-SNAPSHOT.jar
     ```
### 2. Через исходный код:
  1. Клонируйте репозиторий любым удобным способом.
  2. Настройте локальную конфигурацию:
     В папке `src/main/resources` найдите заготовленный файл `application-local.yml.example`. Придумайте пароль и впишите его. Переименуйте файл в `application-local.yml`.
  3. Запустите приложение:
     ```bash
     mvn spring-boot:run
     ```

## REST API эндпоинты

### 1. Получение UDR отчёта для конкретного абонента:
  - URL: `GET /udr/{msisdn}`
  - Параметры:
      - `msisdn`: Номер абонента.
      - `month` (опционально): Месяц в формате `YYYY-MM`.
  - Пример:

    ![Image](https://github.com/user-attachments/assets/26d93f83-3a60-498c-8e0c-0b2c8b9eeb9e)

  - Обработка ошибок:
    - при передаче несуществующего `msisdn` возвращается сообщение `No records found for the specified MSISDN.`.
    - нормализация `msisdn` (удаление лишних символов).
    - контроль на корректный ввод дат, сопровождающийся сообщением-подсказкой.

### 2. Получение UDR отчётов для всех абонентов за месяц:
  - URL: `GET /udr/all`
  - Параметры:
      - month: Месяц в формате `YYYY-MM`.
  - Пример:

    ![Image](https://github.com/user-attachments/assets/9bf7b010-df32-43aa-9da7-7264954f447c)

  - Обработка ошибок:
    - возвращает сообщение `No records found for the specified period.`, если данных по запрашиваемому периоду не существует.
    - контроль на корректный ввод дат, сопровождающийся сообщением-подсказкой.

### 3. Генерация CDR-отчёта:
  - URL: `GET /udr/cdr-report/{msisdn}`
  - Параметры:
      - `msisdn`: Номер абонента.
      - `startDate`: Дата начала периода (ISO 8601).
      - `endDate`: Дата окончания периода (ISO 8601).
  - Пример:

    ![Image](https://github.com/user-attachments/assets/b84c9f35-8c72-4639-a9d9-2ae4bb98da5c)
    
    CSV-файл CDR-отчёта:
    
    ![Image](https://github.com/user-attachments/assets/38a4e546-5046-423a-8ecc-7f95eaf28de4)

  - Обработка ошибок:
    - при передаче несуществующего `msisdn` возвращается сообщение `No records found for the specified MSISDN.`.
    - нормализация `msisdn` (удаление лишних символов).
    - возвращает сообщение `No records found for the specified period.`, если подходящих данных по запрашиваемому периоду нет.
    - контроль на корректный ввод дат, сопровождающийся сообщением-подсказкой. Проверка, что время начала идёт раньше времени конца.

## Работа с Базой Даннных

Для доступа к данным:
1. Перейдите в своём браузере на:
```http://localhost:8081/h2-console```.

2. Введите из `application-local.yml` `url` в `JDBC URL:`, установленные логин и пароль.

3. Нажмите Connect.

Пример:

![Image](https://github.com/user-attachments/assets/41511c62-cf66-4d4c-9f30-67103d19d266)

## Тестирование

### 1. Запуск тестов:
```bash
mvn test
```
### 2. Анализ покрытия тестами:
  - Используйте плагин JaCoCo для анализа покрытия тестами:
    ```bash
    mvn verify
    ```
    или    
    ```bash
    mvn clean test
    ```
  - Отчёт будет доступен по пути:
    ```target/site/jacoco/index.html```

    Покрытие текущего проекта:

    ![Image](https://github.com/user-attachments/assets/5b0bfbdb-a0c8-434f-a11f-35f398ffbea5)

---

## Резюмируя о коде
- Удовлетворяет требованиям ТЗ.
- Обработка ошибок.
- Высокое покрытие тестами.
- Использование dependency injection (внедрение через конструкторы).
- Наличие JavaDoc для ключевых методов.
- Использование `Map` для агрегации данных.
- Попытка минимизации обращения к базе данных.
- Генерация данных пакетами (batch insert).
- Скрыты чувствительные данные в `application-local.yml`.
- Для сущностей выбран подход без Lombok.
- В методе `generateAllUdrReports` была внедрена параллельная обработка через использование `parallelStream()`.


- Код может быть расширен и при необходимости разделён большее количество модулей.
- Временно были добавлены индексы в базе данных, но при текущей нагрузке на приложение в этом не оказалось особой необходимости.
